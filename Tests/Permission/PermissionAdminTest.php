<?php

namespace Kunstmaan\AdminBundle\Tests\Permission;

use Kunstmaan\AdminBundle\Permission\PermissionAdmin;
use Kunstmaan\AdminBundle\Component\Security\Acl\Permission\MaskBuilder;
use Symfony\Component\Security\Acl\Domain\RoleSecurityIdentity;

/**
 * Generated by PHPUnit_SkeletonGenerator on 2012-08-29 at 11:36:29.
 */
class PermissionAdminTest extends \PHPUnit_Framework_TestCase
{
    protected $mockEntityManager;
    protected $mockSecurityContext;
    protected $mockOidRetrievalStrategy;
    protected $mockKernel;

    /**
     * @var PermissionAdmin $object
     */
    protected $object;

    /**
     * Sets up the fixture, for example, opens a network connection.
     * This method is called before a test is executed.
     */
    protected function setUp()
    {
    }

    /**
     * Tears down the fixture, for example, closes a network connection.
     * This method is called after a test is executed.
     */
    protected function tearDown()
    {
    }

    /**
     * @covers Kunstmaan\AdminBundle\Permission\PermissionAdmin::initialize
     * @covers Kunstmaan\AdminBundle\Permission\PermissionAdmin::getPermissions
     */
    public function testInitialize()
    {
        $object = $this->getPermissionAdmin();
        $permissionMap = $this->getMock('Kunstmaan\AdminBundle\Component\Security\Acl\Permission\PermissionMapInterface');
        $shellHelper = $this->getMockBuilder('Kunstmaan\AdminNodeBundle\Helper\ShellHelper')
            ->disableOriginalConstructor()
            ->getMock();

        $object->initialize(null, $permissionMap, $shellHelper);

        $this->assertEquals(array('ROLE_TEST' => new MaskBuilder(1)), $object->getPermissions());
    }

    /**
     * @covers Kunstmaan\AdminBundle\Permission\PermissionAdmin::initialize
     * @covers Kunstmaan\AdminBundle\Permission\PermissionAdmin::getPermission
     */
    public function testGetPermissionWithString()
    {
        $object = $this->getPermissionAdmin();
        $permissionMap = $this->getMock('Kunstmaan\AdminBundle\Component\Security\Acl\Permission\PermissionMapInterface');
        $shellHelper = $this->getMockBuilder('Kunstmaan\AdminNodeBundle\Helper\ShellHelper')
            ->disableOriginalConstructor()
            ->getMock();

        $object->initialize(null, $permissionMap, $shellHelper);

        $this->assertEquals(new MaskBuilder(1), $object->getPermission('ROLE_TEST'));
    }

    /**
     * @covers Kunstmaan\AdminBundle\Permission\PermissionAdmin::initialize
     * @covers Kunstmaan\AdminBundle\Permission\PermissionAdmin::getPermission
     */
    public function testGetPermissionWithRoleObject()
    {
        $object = $this->getPermissionAdmin();
        $permissionMap = $this->getMock('Kunstmaan\AdminBundle\Component\Security\Acl\Permission\PermissionMapInterface');
        $shellHelper = $this->getMockBuilder('Kunstmaan\AdminNodeBundle\Helper\ShellHelper')
            ->disableOriginalConstructor()
            ->getMock();

        $object->initialize(null, $permissionMap, $shellHelper);

        $role = $this->getMock('Symfony\Component\Security\Core\Role\RoleInterface');
        $role->expects($this->once())
            ->method('getRole')
            ->will($this->returnValue('ROLE_TEST'));
        $this->assertEquals(new MaskBuilder(1), $object->getPermission($role));
    }

    /**
     * @covers Kunstmaan\AdminBundle\Permission\PermissionAdmin::initialize
     * @covers Kunstmaan\AdminBundle\Permission\PermissionAdmin::getPermission
     */
    public function testGetPermissionWithUnknownRole()
    {
        $object = $this->getPermissionAdmin();
        $permissionMap = $this->getMock('Kunstmaan\AdminBundle\Component\Security\Acl\Permission\PermissionMapInterface');
        $shellHelper = $this->getMockBuilder('Kunstmaan\AdminNodeBundle\Helper\ShellHelper')
            ->disableOriginalConstructor()
            ->getMock();

        $object->initialize(null, $permissionMap, $shellHelper);
        $this->assertNull($object->getPermission('ROLE_UNKNOWN'));
    }


    /**
     * @covers Kunstmaan\AdminBundle\Permission\PermissionAdmin::__construct
     * @covers Kunstmaan\AdminBundle\Permission\PermissionAdmin::getAllRoles
     */
    public function testGetAllRoles()
    {
        $roleRepo = $this->getMockBuilder('Doctrine\ORM\EntityRepository')
            ->disableOriginalConstructor()
            ->getMock();
        $roleRepo->expects($this->once())
            ->method('findAll')
            ->will($this->returnValue(null));

        $em = $this->getEntityManager();
        $em->expects($this->once())
            ->method('getRepository')
            ->with('KunstmaanAdminBundle:Role')
            ->will($this->returnValue($roleRepo));
        $context = $this->getSecurityContext();
        $aclProvider = $this->getAclProvider();
        $retrievalStrategy = $this->getOidRetrievalStrategy();
        $kernel = $this->getKernel();
        $object = new PermissionAdmin($em, $context, $aclProvider, $retrievalStrategy, $kernel);

        $this->assertNull($object->getAllRoles());
    }

    /**
     * @covers Kunstmaan\AdminBundle\Permission\PermissionAdmin::__construct
     * @covers Kunstmaan\AdminBundle\Permission\PermissionAdmin::getPossiblePermissions
     * @covers Kunstmaan\AdminBundle\Permission\PermissionAdmin::initialize
     */
    public function testGetPossiblePermissions()
    {
        $em = $this->getEntityManager();
        $context = $this->getSecurityContext();
        $aclProvider = $this->getAclProvider();
        $retrievalStrategy = $this->getOidRetrievalStrategy();
        $retrievalStrategy
            ->expects($this->once())
            ->method('getObjectIdentity')
            ->will($this->throwException(new \Symfony\Component\Security\Acl\Exception\AclNotFoundException()));
        $kernel = $this->getKernel();

        $object = new PermissionAdmin($em, $context, $aclProvider, $retrievalStrategy, $kernel);

        $permissions = array('PERMISSION1', 'PERMISSION2');
        $permissionMap = $this->getMock('Kunstmaan\AdminBundle\Component\Security\Acl\Permission\PermissionMapInterface');
        $permissionMap
            ->expects($this->any())
            ->method('getPossiblePermissions')
            ->will($this->returnValue($permissions));
        $shellHelper = $this->getMockBuilder('Kunstmaan\AdminNodeBundle\Helper\ShellHelper')
            ->disableOriginalConstructor()
            ->getMock();

        $object->initialize(null, $permissionMap, $shellHelper);
        $this->assertEquals($permissions, $object->getPossiblePermissions());
    }

    /**
     * @covers Kunstmaan\AdminBundle\Permission\PermissionAdmin::bindRequest
     * @todo   Implement testBindRequest().
     */
    public function testBindRequest()
    {
        // Remove the following lines when you implement this test.
        $this->markTestIncomplete(
          'This test has not been implemented yet.'
        );
    }

    /**
     * @covers Kunstmaan\AdminBundle\Permission\PermissionAdmin::applyAclChangeset
     * @todo   Implement testApplyAclChangeset().
     */
    public function testApplyAclChangeset()
    {
        // Remove the following lines when you implement this test.
        $this->markTestIncomplete(
          'This test has not been implemented yet.'
        );
    }

    public function getEntityManager()
    {
        return $this->getMockBuilder('Doctrine\ORM\EntityManager')
            ->disableOriginalConstructor()
            ->getMock();
    }

    public function getAclProvider()
    {
        return $this->getMock('Symfony\Component\Security\Acl\Model\AclProviderInterface');
    }

    public function getSecurityContext()
    {
        return $this->getMock('Symfony\Component\Security\Core\SecurityContextInterface');
    }

    public function getOidRetrievalStrategy()
    {
        return $this->getMock('Symfony\Component\Security\Acl\Model\ObjectIdentityRetrievalStrategyInterface');
    }

    public function getKernel()
    {
        return $this->getMock('Symfony\Component\HttpKernel\KernelInterface');
    }

    public function getPermissionAdmin()
    {
        $em = $this->getEntityManager();
        $context = $this->getSecurityContext();

        $securityIdentity = new RoleSecurityIdentity('ROLE_TEST');

        $entity = $this->getMockBuilder('Symfony\Component\Security\Acl\Domain\Entry')
            ->disableOriginalConstructor()
            ->getMock();
        $entity
            ->expects($this->any())
            ->method('getSecurityIdentity')
            ->will($this->returnValue($securityIdentity));
        $entity
            ->expects($this->any())
            ->method('getMask')
            ->will($this->returnValue(1));

        $acl = $this->getMockBuilder('Symfony\Component\Security\Acl\Domain\Acl')
            ->disableOriginalConstructor()
            ->getMock();
        $acl->expects($this->once())
            ->method('getObjectAces')
            ->will($this->returnValue(array($entity)));

        $aclProvider = $this->getAclProvider();
        $aclProvider
            ->expects($this->once())
            ->method('findAcl')
            ->with($this->anything())
            ->will($this->returnValue($acl));

        $retrievalStrategy = $this->getOidRetrievalStrategy();
        $objectIdentity = $this->getMock('Symfony\Component\Security\Acl\Model\ObjectIdentityInterface');
        $retrievalStrategy
            ->expects($this->once())
            ->method('getObjectIdentity')
            ->will($this->returnValue($objectIdentity));
        $kernel = $this->getKernel();

        $object = new PermissionAdmin($em, $context, $aclProvider, $retrievalStrategy, $kernel);

        return $object;
    }
}
